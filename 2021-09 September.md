# September 2021

The last issue for the LLVM bump is I had patched two packages, wheel and sphinx, because of a hash mismatch. I figured the tarballs had simply changed and required new hashes but changing the hash caused a similar hash mismatch on Linux. Turns out this problem was due to the file systems involved, which symphorien and VladimirCunat helped me realise. On Linux unicode is usually encoded using UTF-8 and normal form C (NFC). The HFS+ file system, which was the default on macOS until APFS replaced it in High Sierra (10.13), uses UTF-16 and normal form D (NFD). This means hashing the same file name across these file systems can have different results. Both these python packages contain tests using filenames with characters that are represented differently in NFC and NFD, so I patched their sources to use normalization-resistant characters, this seems to have worked fine for [wheel](https://hydra.nixos.org/build/153816175), but not for [sphinx](https://hydra.nixos.org/build/154909760/nixlog/101), looking into it though. Ideally upstream will be interested in these changes otherwise we'll have to carry the patches to guarantee these packages are FODs. A more general solution would be to change the hashing Nix does to normalize all unicode in a fixed way. Not sure this is a path we want to walk though, there are strings which do not round-trip through normal forms so it's not 100% guaranteed to work.

As for the SDK bump, configd remains a hard nut to crack. Somewhere around macOS 10.13 Apple has stopped releasing all the headers that are necessary to build it. XPC no longer seems avoidable as a dependency, CoreFoundation seems incomplete (we rely on Darling for the missing bits now), there's some packages hosted on [opensource.apple.com](https://opensource.apple.com) but not listed in the macOS releases, like neon and OpenBSM. I don't see an alternative to getting the XPC headers from the SDK and likewise for some other missing headers. There's several projects online where missing headers are worked around by stubbing, like [OSXPrivateSDK](https://github.com/samdmarshall/OSXPrivateSDK/blob/f4d52b60e86b496abfaffa119a7d299562d99783/PrivateSDK10.10.sparse.sdk/usr/include/ne_session.h) and [GoVPN](https://github.com/col/GoVPN/blob/1fd467fece7a32a501ee61becf82462755125cf5/GoVPN-Bridging-Header.h), but it doesn't seem like a good way to deal with the issue. Fabricating a constant can lead to unexpected behavior. That's why I intend to use binaries from the SDK whenever dependencies aren't available. This will be a step back with regards to building from source unfortunately.
